<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico">
  <script>
    if (!window.__websocketInterceptorInstalled) {
      console.log('[INTERCEPTOR INLINE] Installation...');
      const OriginalWebSocket = window.WebSocket;

      const isProd = location.hostname !== "localhost";

      // PROTOCOLE AUTOMATIQUE
      const PROD_WS_URL = `${location.protocol === "https:" ? "wss" : "ws"}://10.38.43.251:8000`;

      window.WebSocket = function (url, protocols) {
        let modifiedUrl = url;

        if (!isProd) {
          // ---------- MODE LOCAL ----------
          if (typeof url === 'string') {

            if (url.includes('localhost:5001')) {
              console.warn('[INTERCEPTOR] âŒ Connexion bloquÃ©e:', url);

              const fakeWs = Object.create(OriginalWebSocket.prototype);
              fakeWs.readyState = 3;
              fakeWs.close = () => { };
              setTimeout(() => {
                if (fakeWs.onerror) fakeWs.onerror(new Event('error'));
                if (fakeWs.onclose) fakeWs.onclose(new CloseEvent('close', { code: 1006 }));
              }, 0);
              return fakeWs;
            }

            if (url.startsWith('ws://localhost:8081')) {
              modifiedUrl = url.replace('ws://localhost:8081', 'ws://localhost:5173');
            }
          }
        } else {
          // ---------- MODE PRODUCTION ----------
          if (url.startsWith("ws://") || url.startsWith("wss://")) {
            const urlObj = new URL(url);
            modifiedUrl = `${PROD_WS_URL}${urlObj.pathname}${urlObj.search}`;
            console.log("[INTERCEPTOR] ðŸŒ Redirection PROD â†’", modifiedUrl);
          }
        }

        return new OriginalWebSocket(modifiedUrl, protocols);
      };

      Object.setPrototypeOf(window.WebSocket, OriginalWebSocket);
      window.WebSocket.prototype = OriginalWebSocket.prototype;

      ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'].forEach(prop => {
        Object.defineProperty(window.WebSocket, prop, {
          value: OriginalWebSocket[prop],
          writable: false,
          enumerable: true
        });
      });

      window.__websocketInterceptorInstalled = true;
      console.log('[INTERCEPTOR INLINE] âœ… InstallÃ©');
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Call</title>
</head>

<body>
  <div id="app"></div>
  <script type="module" src="./src/main.ts"></script>
</body>

</html>